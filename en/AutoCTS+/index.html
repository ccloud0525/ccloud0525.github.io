<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an Personal blog about almost everything of me"/>
  <meta name="keyword" content="cloud  blog,Blog"/>
  <link rel="shortcut icon" href="/img/avatar/Barcelona.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://yoursite-url/en/AutoCTS+/">
  <title>
    
      AutoCTS+:Joint Neural Architecture and Hyperparameter Search for Correlated Times Series Forecasting - Ccloud&#39;s
    
  </title>
<meta name="generator" content="Hexo 5.4.2"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'ccloud0525/blogchat'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Ccloud&#39;s</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/lml_bg.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/lml_bg.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/lml_bg.jpg'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/cloud.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#自动机器学习" title="自动机器学习">自动机器学习</a>
              
            </div>
            <h1>AutoCTS+:Joint Neural Architecture and Hyperparameter Search for Correlated Times Series Forecasting</h1>
            <h2 class="subheading">An introduction to AutoCTS+</h2>
            <span class="meta">
              Posted by Cloud on
              2023-02-16
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">15</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">2.4k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <blockquote>
<p>The blog introduces the paper : AutoCTS+</p>
</blockquote>
<h2 id="Introduction">Introduction</h2>
<ul>
<li>
<p>Leveraging the powerful feature extraction capabilities of deep learning models, expert-designed ST-blocks have been proposed to capture spatio-temporal dependencies to enable accurate forecasting.</p>
</li>
<li>
<p>A more recent approach is to automate the design of effective ST-blocks, represented as a supernet-subnet architecture. The goal is to learn the operator-associated weights $[\alpha _i]$, upon which an optimal subnet is obtained by picking the operator with the highest weight between every two nodes.</p>
</li>
<li>
<p>The existing automated CTS forecasting methods above still suffer from three main limitations:</p>
<ul>
<li><strong>Lack of support for joint search for architectures and hyperparameters</strong> .Rely on predefined hyperparameters including architectural hyperparameters(e.g. the number of latent representations, i.e., nodes, in an ST-block and the size of a latent representation) and training hyperparameters(e.g. the dropout rate). Thus semi-automated.</li>
<li><strong>Poor scalability</strong> .The entire supernet must reside in memory during training, which may cause memory overflow in large-scale CTS settings. The memory usage of a supernet goes overflow more than a subnet, which limits the scalability of neural architecture search.</li>
<li><strong>One-time use</strong>. Existing automated CTS forecasting methods train a supernet for each specific dataset from scratch, which is costly.</li>
</ul>
</li>
<li>
<p><strong>SEARCH, A Scalable and Efficient joint ARChitecture and Hyperparameter search framework</strong> is proposed to address the limitations above.</p>
<ul>
<li>Propose a novel search space for correlated time series forecasting to facilitate joint search for <strong>architectures and hyperparameter</strong> settings.</li>
<li>A memory-efficient Architecture-Hyperparameter Comparator (AHC) is proposed to rank arch-hyper candidates that encompasses an easy-to-obtain <strong>proxy metric</strong> to generate pseudo-labels to train an AHC in a denoising manner, thereby improving search efficiency.</li>
<li>Propose a <strong>transfer</strong> method that is able to quickly adapt a trained AHC to a new dataset, thus significantly improving the AHC training efficiency on new datasets.</li>
<li>Extensive experiments on six benchmark datasets show that SEARCH is able to efficiently find better-performing CTS forecasting models compared to state-of-the-art manual and automatic methods.</li>
</ul>
</li>
</ul>
<p><img src="cmp.png" alt="cmp"></p>
<h2 id="Preliminaries">Preliminaries</h2>
<h3 id="Problem-Settings">Problem Settings</h3>
<p>The single-step CTS forecasting:</p>
<p>$$\hat{X} _{t+P+Q} = \mathcal{F}(X _{t+1}, X _{t+2},…,X _{t+P};G)$$</p>
<p>The multi-step CTS forecasting:</p>
<p>$$(\hat{X} _{t+P+1},\hat{X} _{t+P+2},…,\hat{X} _{t+P+Q}) = \mathcal{F} (X _{t+1},X _{t+2},…,X _{t+P};G)$$</p>
<p>where $x _t \in \mathbb{R} ^{N \times F}$ denotes the feature vectors of all time series at timestamp $t$. The combined data is $\mathcal{X} \in \mathbb{R} ^{N \times T \times F}$. $G = (V,E,A)$, where $V$ denotes the sensors, $E$ denotes the correlation relationships between sensors, $A$ denotes the adjacency matrix about the strengths of the relationships between time series.</p>
<p>The goal is to automatically build an optimal ST-block $\mathcal{F} ^\ast$ from a predefined combined architecture-hyperparameter search space $S$ that minimizes the forecasting error on a validation dataset $\mathcal{D} _{val}$.</p>
<p>$$\mathcal{F} ^\ast = \underset{\mathcal{F} \in S}{argmin} ErrorMetric (\mathcal{F},\mathcal{D} _{val})$$</p>
<h3 id="Forecasting-Models">Forecasting Models</h3>
<p>The common framework of manually designed neural CTS forecasting models has three components: an input module, an ST-backbone and an output module.</p>
<p><img src="CTS_model.png" alt="CTS_model"></p>
<p>The specific types of <strong>S/T-operators</strong> in ST-blocks and their connections are critical to the success of a CTS forecasting model.</p>
<h3 id="Existing-Automated-Methods">Existing Automated Methods</h3>
<p>Existing Automated Methods(AutoCTS) take account of the design of ST-blocks and ST-backbone by using the method proposed in <strong>DARTS</strong> so that the model can be trained by gradient descent.</p>
<h2 id="SCALABLE-AND-EFFICIENT-JOINT-SEARCH">SCALABLE AND EFFICIENT JOINT SEARCH</h2>
<h3 id="Joint-Search-Space">Joint Search Space</h3>
<p>The joint search space considers two aspects of ST-blocks:</p>
<ol>
<li>the architecture, including operators and their connections</li>
<li>the hyperparameters, including architecture-related structural hyperparameters(e.g., the hidden dimension) and optimization-related training hyperparameters(e.g. the dropout rate).</li>
</ol>
<h4 id="Architecture-Search-Space">Architecture Search Space</h4>
<p><strong>Candidate operators</strong></p>
<p>Obtain a candidate operator set $O$ composed of five operators, i.e.</p>
<p>The “identity” operator to support skip-connections between nodes.</p>
<p>Two T-operators:</p>
<ol>
<li><strong>The Gated Dilated Causal Convolution</strong> used to capture <em>short-term</em> temporal dependencies.</li>
<li><strong>Informer(INF-T)</strong> excels at learning <em>long-term</em> temporal dependencies.</li>
</ol>
<p>Two S-operators:</p>
<ol>
<li><strong>The Diffusion Graph Convolution Network</strong> is effective at capturing <em>static spatial correlations</em>.</li>
<li><strong>Informer(INF-S)</strong> is effective at discovering <em>dynamic spatial correlations</em>.</li>
</ol>
<p>The set $O$ can accommodate additional operators by following steps:</p>
<ol>
<li>
<p>Include the operator in the candidate operator set $O$.</p>
</li>
<li>
<p>Sample some arch-hypers that include the new operator and use them to generate additional clean and noisy samples to retrain the AHC.</p>
</li>
<li>
<p>The clean and noisy samples collected before can be reused when retraining the AHC, and AHC training is quite efficient.</p>
</li>
</ol>
<p><strong>Topological connections</strong></p>
<p>Consider the possible topological connections among the operators within an ST-block.</p>
<p>An ST-block can be represented a directed acyclic graph (DAG) $G _d$ with $C$ nodes, where each node $h _i$ represents a feature representation and each edge represents an operator $O _i$. Propose the rules to generate candidate ST-blocks:</p>
<ol>
<li>There is at most one edge from node $h _i$ to node $h _j$, and no edge is allowed from node $h _j$ to node $h _i$, where $i &lt; j$.</li>
<li>The operator on an edge is selected from the chosen candidate set, including the identity operator.</li>
</ol>
<p><img src="ST_block.png" alt="ST_block"></p>
<h4 id="Hyperparameter-Search-Space">Hyperparameter Search Space</h4>
<p>Consider two kinds of hyperparameters:</p>
<ol>
<li>Structural hyperparameters</li>
<li>Training hyperparameters</li>
</ol>
<p><img src="hyper.png" alt="hyper"></p>
<p>The framework can easily include additional hyperparameters as well as expanded ranges of values for existing hyperparameters.</p>
<p><strong>Structural hyperparameters</strong> related to the sepcific structure of an ST-block.</p>
<p>$U$ denotes the output mode, takes the last node as the output or takes the sum of all nodes as the output.</p>
<p><strong>Training hyperparameters</strong> include the dropout rate $\delta$.</p>
<h4 id="Encoding-of-the-Joint-Search-Space">Encoding of the Joint Search Space</h4>
<p>Combine the Architecture and Hyperparameter search spaces to construct a joint search space to support the search for an optimal arch-hyper.</p>
<p>Design the joint search space as a joint dual  DAG:</p>
<ol>
<li>Convert the original DAG $G _d$ of an architecture in the architecture search space into its dual graph $G _d ^\ast$ where nodes represent operators and edges represent information flow.</li>
<li>Add a new “Hyper” node that represents the hyperparameter setting on the architecture to the dual DAG  and it connects to all other nodes. So that a single DAG can represent a complete ST-block containing both the candidate architecture and the hyperparameters.</li>
</ol>
<p><img src="arch_hyper.png" alt="arch_hyper"></p>
<p>Use an adjacency matrix $A _a$ and a feature matrix $F _a$ to encode an arch-hyper graph $G _a$.</p>
<p>$A_a \in \mathbb{R} ^{(n+1) \times (n+1)}$ reflects the topology information of $G _a$,where the binary value of an entry $(i,j)$ indicates whether there is information flow between these two nodes. Self-connections are also added to all nodes.</p>
<p>$F _a \in \mathbb{R} ^{(n+1) \times D}$ contains operator information of each node.</p>
<p>For the “Hyper” node, the original feature is an $r$-dimensional vector from the hyperparameter search space. Employ min-max normalization to normalize the original feature of the “Hyper” node and then convert the normalized feature into a $D$-dimensional embedding:</p>
<p>$$F _h = norm(H _o) W _c$$</p>
<p>where $H _o \in \mathbb{R} ^r$ is the original feature vector of the “Hyper” node and $W _c \in \mathbb{R} ^{r \times D}$ is learnable matrix, and $F _h \in \mathbb{R} ^D$ is the embedding of the “Hyper” node.</p>
<p>For the other $n$ operator nodes, first embed each operator with an one-hot embedding and then introduce a learnable matrix that converts the one-hot embeddings of all operator nodes into an embedding matrx:</p>
<p>$$F _e = H _e W _e$$</p>
<p>where $H _e \in \mathbb{R} ^{n \times |O|}$ and $F _e \in \mathbb{R} ^{n \times D}$ are the one-hot embeddings and the transformed embedding matrix of the $n$ nodes. $W _e \in \mathbb{R} ^{|O| \times D}$ is the learnable matrix, and $|O|$ is the number of candidate operator types in the architecture search space.</p>
<p>$$F _a = concatenate(F _h,F _e)$$</p>
<p>This way, each arch-hyper in the joint search space can be encoded as an adjacency matrix $A _a$ and a feature matrix $F _a$.</p>
<p>$W _c$ and $W _e$ are learned together with the model parameters of the AHC.</p>
<h3 id="Architecture-Hyperparameter-Comparator">Architecture-Hyperparameter Comparator</h3>
<p>Propose an architecture-hyperparameter comparator(AHC) to compare and rank the arch-hypers so that one could avoid evaluating all candidate pairs.</p>
<p>Many existing studies propose an accuracy estimator(a neural network) trained by a large volume of $(ah, R(ah))$, where $ah$ is an arch-hyper and $R(ah)$ is the validation accuracy of a full obtained $ah$.  It is very time-consuming. Instead of comparing by an absolute accuracy, using the relative comparison result of two arch-hypers is sufficient to obtain their ranking.</p>
<p>Use a comparator to achieve the relative accuracy relation of two candidate arch-hypers.</p>
<p>Given a measured $(ah ,R(ah))$ pairs to build $a(a-1)$ training samples for $AHC$ in the form of $(ah _1,ah _2,y)$ by pairing every two of $(ah,R(ah))$ pairs, where $y$ is the binary value indicating which arch-hyper has higher accuracy, thus alleviating the issue of requiring a large amount of training samples.</p>
<p>A well trained AHC can rank all $(ah _1,ah _2)$ pairs from the joint search space.</p>
<p><img src="AHC.png" alt="AHC"></p>
<p>Considering the powerful ability of GIN(Graph Isomorphism Network) to distinguish any two graphs, leverage GINs to encode the arch-hyper as a compact continuous embedding.</p>
<p>$$GIN(A _a,F _a) = H ^{(L)}$$</p>
<p>$$H ^{(k)} = MLP ^{(k)}((1+\epsilon ^{(k)})\cdot H ^{(k-1)}+AH ^{(k-1)}),k=1,2,…,L$$</p>
<p>where $L$ is the number of GIN layers, $H ^{(0)} = F _a$, $\epsilon$ is a trainable bias, and <em>MLP</em> is the multi-layer perceptron.</p>
<p>Use $l _a$ to represent an arch-hyper.</p>
<p>$$L _a = concatenate(l _a,l _a’)$$</p>
<p>$$output = \mathbb{1}(\sigma(FC(L,w _l)) &gt;= 0.5)$$</p>
<p>GIN is proposed in the following paper “How powerful are Graph Neural Networks?”</p>


	<div class="row">
    <embed src="GIN.pdf" width="100%" height="550" type="application/pdf">
	</div>



<p>The Weisfeiler_Lehman_Isomorphism_Test is shown as followed:</p>


	<div class="row">
    <embed src="prove.pdf" width="100%" height="550" type="application/pdf">
	</div>



<h3 id="Training-AHC-with-Noisy-Proxies">Training AHC with Noisy Proxies</h3>
<p>Design a computation-efficient $R’(\cdot)$ to easily obtain a large number of noisy training samples $(ah _1,ah _2,y’)$.</p>
<h4 id="Proxy-Performance-Metric">Proxy Performance Metric</h4>
<p>Naively using proxy metrics form CV domain can create severely  mislabeled training samples $(ah _1,ah _2,y’)$ and is too noisy to achieve a reliable AHC.</p>
<p>Propose a computation-efficient proxy metric specifically for CTS forecasting which performs better than metircs from CV domain(e.g. (nparam) , Synflow , Snip, (NTK) score).</p>
<p>During experiments, the author notices that if the validation accuracy of an arch-hyper is higher than another in the first few epochs, then its final validation accuracy is very likely to be higher as well.</p>
<p>So the author proposes to train an arch-hyper for only $k&lt;=5$ epochs and use the validation accuracy of the under-trained model as a proxy.</p>
<p><em>early-validation proxy:</em></p>
<p>$$R’(ah) = ErrorMetric(\mathcal{F}(ah) _k ,\mathcal{D} _{val})$$</p>
<p>where $\mathcal{F} (ah) _k$ is the CTS forecasting model under arch-hyper setting $ah$ with only $k$ epochs training.</p>
<p><img src="exp1.png" alt="exp1"></p>
<p><img src="proxy_metric.png" alt="proxy_metric"></p>
<h4 id="Training-AHC-with-denoising-algorithms">Training AHC with denoising algorithms</h4>
<p>To minimize the impact  of training with noisy samples, the author fully train a few additional arch-hypers to obtain clean training samples of the form $(a h_1,ah _2,y)$ and then train the AHC with both noisy and clean samples in a denoising manner.</p>
<p>Adopt a commonly used denoising training method, <strong>fine-tune</strong>.</p>
<ol>
<li>Randomly sample $L _1$ arch hypers from the joint search space and use the proposed proxy metric to obtain the proxy score $R’(ah)$ for each arch-hyper $ah$.</li>
<li>Pair up these arch-hypers to produce $L _1(L _1 - 1)$ noisy samples of the form $(ah _1,ah _2,y’)$.</li>
<li>Randomly sample $L _2(L _2 &lt;&lt; L _1)$ arch-hypers and train them completely to obtain the validation accuracy $R(ah)$ for each arch-hyper $ah$.</li>
<li>Also pair up these arch-hypers to produce $L _2(L _2 -1)$ clean samples of the form $(ah _1,ah _2,y)$.</li>
</ol>
<p>The processes of collecting noisy and clean samples are independent and can be highly parallelized. After collecting noisy and clean samples, the author first warm up the AHC for $k _t$ epochs using the noisy samples, and then use the clean samples to finetune the AHC until convergence.</p>
<h3 id="Search-Strategy-and-AHC-Transfer">Search Strategy and AHC Transfer</h3>
<h4 id="Search-Strategy">Search Strategy</h4>
<p>Since the joint seach space is enormous, it is inefficient to compare all candidate arch-hypers using the AHC to get the optimal one.</p>
<p>Address the issue with following steps:</p>
<ol>
<li>
<p>Remove the arch-hypers that do not contain either spatial or temporal operators.</p>
</li>
<li>
<p>Consider a heuristic approach e.g., evolutionary algorithm to find the best arch-hyper in the shrunk joint search space.</p>
</li>
<li>
<p>First sample $K _s$ arch-hypers, which are paired up to produce $K _s(K _s -1)/2$ comparison pairs of the form $(ah _1,ah _2)$, and the descending ranking of the $K _s$ arch-hypers can be easily obtained based on the comparative performance determined by the trained AHC.</p>
</li>
<li>
<p>Select the top $K _p$ from the $K _s$ arch-hypers in descending order as the initial population. Each arch-hyper has crossover and mutation probability $p _1$ and $p _2$​​, respectively, when generating new offspring in each evolution step. The offspring are added to the population, and the learned AHC is used to compare arch-hypers in the population and to remove inferior arch-hypers to keep the population size at $K _p$ .</p>
</li>
<li>
<p>Choose the top-$K$ arch-hypers from the population to collect their exact forecasting accuracy and pick the one with the highest accuracy as the final searched ST-block.</p>
</li>
</ol>
<p>The evolutionary algorithm is shown as followed:</p>


	<div class="row">
    <embed src="Evolutionary.pdf" width="100%" height="550" type="application/pdf">
	</div>



<h4 id="Transfer-a-well-trained-AHC">Transfer a well-trained AHC</h4>
<p>Give a well-trained AHC $\mathcal{N} _s$ on a source dataset $D _s$ (use $L _1$ noisy samples and $L _2$ clean samples for training), a new well-trained AHC $\mathcal{N} _s$ from $D _s$ to $D _t$ with much less arch-hyper samples $ah _t$ on $D _t$:</p>
<p>$$\mathcal{N} _t(D _t) \overset{ah _t}{\longleftarrow} \mathcal{N} _s (D _s)$$</p>
<p>where $ah _t$ consists of $z _1$ noisy samples and $z _2$ clean samples, and $z _1 &lt;&lt; L _1,z _2 &lt;&lt; L _2$. The transfer process is particularly implemented using the fine-tuning technique.</p>
<p><img src="search_algorithm.png" alt="search_algorithm"></p>
<h2 id="Experiments">Experiments</h2>
<p><img src="exp2.png" alt="exp2"></p>
<p><img src="exp3.png" alt="exp3"></p>
<p><img src="exp5.png" alt="exp5"></p>
<p><img src="exp4.png" alt="exp4"></p>
<p><img src="exp6.png" alt="exp6"></p>
<h2 id="The-paper">The paper</h2>


	<div class="row">
    <embed src="AutoCTS+.pdf" width="100%" height="550" type="application/pdf">
	</div>




        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/AutoST_1/" data-toggle="tooltip" data-placement="top" title="AutoST:Efficient Neural Architecture Search for Spatio-Temporal Prediction">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/en/DARTS/" data-toggle="tooltip" data-placement="top" title="DARTS:Differentiable Architecture Search">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=AutoCTS+:Joint Neural Architecture and Hyperparameter Search for Correlated Times Series Forecasting&body=Hi,I found this website and thought you might like it http://yoursite-url/en/AutoCTS+/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '04b857744df6aca41a4b',
      clientSecret: '46345ef524913d79f188d03d10e82693a1b90cbe',
      repo: 'blogcomment',
      owner: 'ccloud0525',
      admin: 'ccloud0525',
      id: 'Thu Feb 16 2023 22:36:00 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'zh-CN',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Introduction"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Introduction</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Preliminaries"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Preliminaries</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Problem-Settings"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">Problem Settings</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Forecasting-Models"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">Forecasting Models</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Existing-Automated-Methods"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">Existing Automated Methods</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#SCALABLE-AND-EFFICIENT-JOINT-SEARCH"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">SCALABLE AND EFFICIENT JOINT SEARCH</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Joint-Search-Space"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">Joint Search Space</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Architecture-Search-Space"><span class="toc-nav-number">3.1.1.</span> <span class="toc-nav-text">Architecture Search Space</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Hyperparameter-Search-Space"><span class="toc-nav-number">3.1.2.</span> <span class="toc-nav-text">Hyperparameter Search Space</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Encoding-of-the-Joint-Search-Space"><span class="toc-nav-number">3.1.3.</span> <span class="toc-nav-text">Encoding of the Joint Search Space</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Architecture-Hyperparameter-Comparator"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">Architecture-Hyperparameter Comparator</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Training-AHC-with-Noisy-Proxies"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">Training AHC with Noisy Proxies</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Proxy-Performance-Metric"><span class="toc-nav-number">3.3.1.</span> <span class="toc-nav-text">Proxy Performance Metric</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Training-AHC-with-denoising-algorithms"><span class="toc-nav-number">3.3.2.</span> <span class="toc-nav-text">Training AHC with denoising algorithms</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Search-Strategy-and-AHC-Transfer"><span class="toc-nav-number">3.4.</span> <span class="toc-nav-text">Search Strategy and AHC Transfer</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Search-Strategy"><span class="toc-nav-number">3.4.1.</span> <span class="toc-nav-text">Search Strategy</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Transfer-a-well-trained-AHC"><span class="toc-nav-number">3.4.2.</span> <span class="toc-nav-text">Transfer a well-trained AHC</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Experiments"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">Experiments</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#The-paper"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">The paper</span></a></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#自动机器学习" title="自动机器学习">自动机器学习</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://github.com/Cyria7" target="_blank">Cyria7</a>
          </li>
          
          <li>
            <a href="https://github.com/ameki77" target="_blank">ameki77</a>
          </li>
          
          <li>
            <a href="https://picasun.github.io/" target="_blank">Picasun</a>
          </li>
          
          <li>
            <a href="https://hexo.io/" target="_blank">Hexo</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/ccloud0525">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          
            <li>
              <a target="_blank" href="https://www.zhihu.com/people/tian-xing-jian-82-19">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse">知</i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="http://weibo.com/6386058030">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Cloud
          2023
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://yoursite-url/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_CHTML"></script>


</body>
</html>
