<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an Personal blog about almost everything of me"/>
  <meta name="keyword" content="cloud  blog,Blog"/>
  <link rel="shortcut icon" href="/img/avatar/limit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://yoursite-url/en/STTN/">
  <title>
    
      STTN:Spatial-Temporal Transformer Networks for Traffic Flow Forecasting - Ccloud&#39;s
    
  </title>
<meta name="generator" content="Hexo 5.4.2"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'ccloud0525/blogchat'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Ccloud&#39;s</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/lml_bg.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/lml_bg.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/lml_bg.jpg'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/cloud.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#注意力机制" title="注意力机制">注意力机制</a>
              
            </div>
            <h1>STTN:Spatial-Temporal Transformer Networks for Traffic Flow Forecasting</h1>
            <h2 class="subheading">An introduction to STTN</h2>
            <span class="meta">
              Posted by Cloud on
              2023-02-05
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">12</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">1.9k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <blockquote>
<p>The blog introduces the paper : STTN</p>
</blockquote>
<h2 id="Introduction">Introduction</h2>
<ul>
<li>
<p>Models with stationary assumption are not practical in long-term forecasting, as traffic flows are highly dynamical in nature.</p>
</li>
<li>
<p>CNN-based and RNN-based models are restricted for traffic forecasting in the following two aspects</p>
<ul>
<li>
<p><strong>Fixed Spatial Dependencies</strong><br>
For each sensor, its correlated sensors vary with the forecasting. Fig1(a) shows that for the target node(purple), different correlated nodes(red) are considered to formulate the spatial dependencies for different time steps(e.g. $\tau -1,\tau-2,\tau-3$), according to the range(red circle) determined by the traffic speeds and distances.<br>
<img src="irregular.png" alt="irregular"></p>
<p>Furthermore, it is important to capture the dynamical spatial dependencies. Spatial dependencies irregularly oscillate with time steps, due to the periodical effect of rush hours, varying weather conditions and unexpected occurrence of traffic accidents as shown in Fig1(b).</p>
</li>
<li>
<p><strong>Limited-range Temporal Dependencies</strong><br>
Long-range temporal dependencies are usually ignored in existing methods.</p>
<p>Fig1(a) illustrates spatial dependencies with various scales for different time steps, which implies that prediction performance would be degraded by limiting the range of temporal dependencies.<br>
Furthermore, prediction errors would be propagated and accumulated for long-term traffic forecasting with existing auto-regressive methods trained with either individual loss for each time step or joint loss for multiple time steps, as depicted in Fig2(a).<br>
<img src="vary.png" alt="vary"><br>
It is desirable to achieve accurate long-term perdicition based on long-range temporal dependencies extarcted form error-free temporal contexts as shown in Fig2(b).</p>
</li>
</ul>
</li>
<li>
<p>STTN is proposed to address aforementioned challenges. The contributions of the paper are summarized as below:</p>
<ul>
<li>Develop a spatial-temporal block to dynamically<br>
model long-range spatial-temporal dependencies.</li>
<li>Present a new variant of GNNs, named <em>spatial transformer</em>, to model the time-varying directed spatial dependencies and dynamically capture the hidden spatial patterns of traffific flflows.</li>
<li>Design a <em>temporal transformer</em> to achieve multi-step prediction using long-range temporal dependencies.</li>
</ul>
</li>
</ul>
<h2 id="Proposed-Model">Proposed Model</h2>
<p>Formulate the  traffic forecasting task as a spatial-temporal prediction problem. The model consists of two main components: spatial-temporal (ST) block and prediction layer.</p>
<h3 id="Problem-Formulation">Problem Formulation</h3>
<p>As other traffic network, the model can be respresented as:</p>
<p>$$\hat{v} ^{\tau + 1},…, \hat{v} ^{\tau + T} = \mathcal{F} (v ^{\tau - M +1},…,v ^{\tau}; \mathcal{G})$$</p>
<p>To achieve accurate prediction, $\mathcal{F}$ captures dynamical spatial dependencies $S _\tau ^\mathcal{S} \in \mathbb{R} ^{N \times N}$ and long-range temporal dependencies $S _\tau ^\mathcal{T} \in \mathbb{R} ^{M \times M}$ from $v ^{\tau -M +1},…,v ^\tau$ and $\mathcal{G}$.</p>
<h3 id="Overall-Architecture">Overall Architecture</h3>
<p><img src="Architecture.png" alt="Architecture"></p>
<h4 id="Spatial-temporal-Blocks">Spatial-temporal Blocks</h4>
<p>As shown in Fig3, the input to the $l$-th spatial-temporal block is a 3-D tensor $X _l ^\mathcal{S} \in \mathbb{R} ^{M \times N \times d _{\mathcal{G}}}$ of $d _{\mathcal{G}}$-dimensional features for the $N$ nodes at time steps $\tau - M +1,…,\tau$ extracted by the $l-1$-th spatial-temporal block. The spatial transformer $\mathcal{S}$ and temporal transformer $\mathcal{T}$ are stacked to generate the 3-D output tensor. Residual connections are adopted to for stable training.  In the $l$-th spatial-temporal block, the spatial transformer $\mathcal{S}$ extracts spatial features $Y _l ^\mathcal{S}$ from the input node feature $X _l ^\mathcal{S}$ as well as graph adjacency matrix $A$</p>
<p>$$Y _l ^\mathcal{S} = \mathcal{S} (X _l ^\mathcal{S},A)$$</p>
<p>$Y _l ^\mathcal{S}$ is combined with $X _l ^\mathcal{S}$ to generate the input $X _l ^\mathcal{T}$ to the subsequent temporal transformer</p>
<p>$$Y _l ^\mathcal{T} = \mathcal{T} (X _l ^\mathcal{T})$$</p>
<p>$$X _{l+1} ^{\mathcal{S}} = Y _l ^{\mathcal{T}} + X _l ^{\mathcal{T}}$$</p>
<h4 id="Prediction-Layer">Prediction Layer</h4>
<p>The prediction layer leverages two classical convolutional layer to make multi-step prediction based on the spatial-temporal features from the last spatial-temporal block. Its input is a 2-D tensor $X ^{\mathcal{S}\mathcal{T}} \in \mathbb{R} ^{N \times d ^{\mathcal{S} \mathcal{T}}}$ that consists of the $d ^{\mathcal{S} \mathcal{T}}$-dimensional spatial-temporal features of the $N$ nodes for last time step $\tau$. The mulit-setp prediction $Y \in \mathbb{R} ^{N \times T}$ for $T$ future traffic conditions of the $N$ nodes is</p>
<p>$$Y = Conv(Conv(X ^{\mathcal{S} \mathcal{T}}))$$</p>
<p>Mean absolute loss are adopted to train the model</p>
<p>$$L = || Y - Y ^{gt}|| _1$$</p>
<p>where $Y ^{gt} \in \mathbb{R} ^{N \times T}$ is the groundtruth traffic speeds.</p>
<h3 id="Spatial-Transformer">Spatial Transformer</h3>
<p><img src="Spatial_Transformer.png" alt="Spatial_Transformer"></p>
<p>The spatial transformer consists of <strong>spatial-temporal positional embedding layer</strong>, <strong>fixed graph convolution layer</strong>,<strong>dynamical graph convolution layer</strong> and <strong>gate mechanism for information fusion</strong>.</p>
<h4 id="Spatial-Temporal-Positional-Embedding">Spatial-Temporal Positional Embedding</h4>
<p>The spatial dependencies of two nodes in the graph would be determined by their distances and observed time steps. Transformer cannot capture the spatial (position) and temporal information of observations with the fully connected feed-forward structures.</p>
<p>Thus, the prior positional embedding is to encode the ‘position’ information into the input sequences. Adopt the <strong>spatial-temporal positional embedding layer</strong> to learn the spatial-temporal embedding into each node feature. The parameter matrices $\hat{D} ^{\mathcal{S} } \in \mathbb{R} ^{N \times N}$ and $\hat{D} ^{\mathcal{T}} \in \mathbb{R} ^{M \times M}$ are the dictionaries.</p>
<p>$\hat{D} ^{\mathcal{S} }$ is initialized with the graph adjacency matrix to consider the connectivity and distance between nodes for modeling spatial dependencies, while $\hat{D} ^{\mathcal{T} }$ is initialized with one-hot time encoding to inject the time step into each node.</p>
<p>$\hat{D} ^{\mathcal{S} }$ and $\hat{D} ^{\mathcal{T} }$are tiled along the spatial and temporal axes to generate $D ^{\mathcal{S}} \in \mathbb{R} ^{M \times N \times N}$ and $D ^{\mathcal{T}} \in \mathbb{R} ^{M \times N \times M}$.Concatenate them as $[X ^{\mathcal{S}},D ^{\mathcal{S}},D ^{\mathcal{T}}]$ and use a $1 \times 1$ convolutional layer $F _t$ to decreases the dimension to $d _\mathcal{G}$</p>
<p>$$X ^{'S} = F _t ([X ^{\mathcal{S}},D ^{\mathcal{S}},D ^{\mathcal{T}}]) \in \mathbb{R} ^{M \times N \times d _\mathcal{G}}$$</p>
<p>Fed the $X ^{'S}$ into the fixed and dynamical graph convolutional layers for spatial feature learning. Since graph convolution operations can be realized in parallel for the $M$ time steps via tensor operations, consider the 2-D tensor $\hat{X} ^S \in \mathbb{R} ^{N \times d _\mathcal{G}}$ of  $X ^{'S}$ for arbitrary one time step for brevity.</p>
<h4 id="Fixed-Graph-Convolutional-Layer">Fixed Graph Convolutional Layer</h4>
<p>Use the graph spectral convolution based on Chebyshev polynomial approximation to capture the stationary spatial dependencies form the road topology.</p>
<p>Extract the structure-aware features:</p>
<p>$$\hat{X} _{:,j} ^\mathcal{G} = \sum _{i=1} ^{d _\mathcal{G}} \sum _{k=0} ^{K} \theta _{ij,k} T _k (\tilde{L}) \hat{X} _{:,i} ^S \quad \forall j=0,…,d _\mathcal{G}$$</p>
<p>where $\hat{X} _{:,j} ^\mathcal{G}$ is the $j$-th channel(column) of $\hat{X} ^\mathcal{G}$ and $\theta _{ij,k}$ is the learned weights. Since $\mathcal{G}$ is constructed based on the physical connectivity and distance between sensors, the stationary spatial dependencies determined by the road topology can be explicity explored through the fixed graph convolutional layer.</p>
<h4 id="Dynamical-Graph-Convolutional-Layer">Dynamical Graph Convolutional Layer</h4>
<p>To capture the time-evolving hidden spatial dependencies, the author proposes a novel dynamical graph convolutional layer to achieve training and modeling in the high-demensional latent subspaces.</p>
<p><img src="latent.png" alt="latent"></p>
<p>Learn the linear mappings that project the input features of each node to the high-dimensional latent subspaces. Then utilize the dynamic nature of self-attention mechanism to address the projected features to efficiently model the dynamical spatial dependencies between node according to the varying graph signals.</p>
<p>The process is as follows:</p>
<p>$$Q ^S = \hat{X} ^S W _q ^S$$</p>
<p>$$K ^S = \hat{X} ^S W _k ^S$$</p>
<p>$$V ^S = \hat{X} ^S W _v ^S$$</p>
<p><img src="self_attention.png" alt="self_attention"></p>
<p>$$S ^S = softmax(Q ^S(K ^S) ^T / \sqrt{d _{\mathcal{A}} ^S})$$</p>
<p>$$M ^S = S ^S V ^S$$</p>
<p>It is worth mentioning that multiple patterns of spatial dependencies can be learned with mulit-head attention mechanism by introducing multiple pairs of subsapces.</p>
<p>Furthermore a shared three-layer feed-forward nerual network with nonlinear activation is applied on each node:</p>
<p>$$U ^S = ReLu(ReLu(\hat{M} ^{'S}W _0 ^S)W _1 ^S)W _2 ^S$$</p>
<p>where $M ^{'S} = \hat{X} ^{S} + M ^{S}$ is the residual connections.</p>
<p>$U ^S$ and $M ^{'S}$ are combined by $\hat{Y} ^S = U ^S +M ^{'S}$ for feature fusion with the gate mechanism</p>
<h4 id="Gate-Mechanism-for-Feature-Fusion">Gate Mechanism for Feature Fusion</h4>
<p>The gate mechanism is developed to fuse the spatial features learned from fifixed and dynamical graph convolutional layers. The gate $g$ is derived from $Y ^{'S}$and $X ^S$of the fixed and dynamical graph convolutional layers.</p>
<p>$$g = sigmoid(f _S (\hat{Y} ^S) + f _\mathcal{G}(X ^\mathcal{G}))$$</p>
<p>where $f _\mathcal{G}$ and $f _S$ are linear projections that transform $Y ^{'S}$ and $X ^\mathcal{G}$ into 1-D vectors</p>
<p>$$Y ^{'S} = g\hat{Y} ^S + (1-g)X ^\mathcal{G}$$</p>
<h4 id="General-Dynamical-Graph-Neural-Networks">General Dynamical Graph Neural Networks</h4>
<p>The spatial transformer can be viewed as a general message-passing dynamical graph neural network.</p>
<p>The author demonstrates that the spatial transformer can be formulated as an iterative feature learning process of message passing and update for all the nodes $v \in \mathcal{V}$ in a dynamical graph neural network.</p>
<p>Denote $x _v \in \mathbb{R} ^{d _\mathcal{G}}$ the input features of node $v$. For arbitrary $v \in \mathcal{V}$ ,it receives the message $m _v  \in \mathbb{R} ^{d _\mathcal{G}}$ from the nodes in $\mathcal{V}$</p>
<p>$$m _v = \sum _{u \in \mathcal{V}} F(x _v,x _u) = \sum _{u \in \mathcal{V}} \langle (W _q ^S) ^T x _v,(W _k ^S) ^T x _u \rangle x _u$$</p>
<p>where $F$ is the composite message-passing function that realizes Eqs. When $m _v$ is obtained, $x _v$ is updated with $y _v$ calculated from $m _v$ and $x _v$</p>
<p>$$y _v = G (m _v,x _v)$$</p>
<p>where $G$ is the shared position-wise feed forward network.</p>
<h3 id="Temporal-Transformers">Temporal Transformers</h3>
<p><img src="temporal_transformer.png" alt="temporal_transformer"></p>
<p>Similar to the spatial transformer, $X ^{’ \mathcal{T}} = G _t ([X ^\mathcal{T},D ^\mathcal{T}]) \in \mathbb{R} ^{M \times N \times d _\mathcal{G}}$ is obtained from the concatenation of the input features $X ^\mathcal{T} = X ^S + Y ^S \in \mathbb{R} ^{M \times N \times d _\mathcal{G}}$ and the temporal embedding $D ^\mathcal{T}$ ,where $G _t$ is a $1 \times 1$ convolutional layer that yields a $d _\mathcal{G}$-dimension vector for each node at each time step. Parallelize over the nodes to model temporal dependencies. The 2-D tensor of spatial features $\hat{X} ^\mathcal{T} \in \mathbb{R} ^{M \times d _\mathcal{G}}$is considered for arbitrary one node in $\mathcal{G}$.</p>
<p>The process is as follows:</p>
<p>$$Q ^\mathcal{T} = \hat{X} ^\mathcal{T} W _q ^\mathcal{T}$$</p>
<p>$$K ^\mathcal{T} = \hat{X} ^\mathcal{T} W _k ^\mathcal{T}$$</p>
<p>$$V ^\mathcal{T} = \hat{X} ^\mathcal{T} W _v ^\mathcal{T}$$</p>
<p>$$S ^\mathcal{T} = softmax(Q ^\mathcal{T}(K ^\mathcal{T}) ^T / \sqrt{d _{\mathcal{A}} ^\mathcal{T}})$$</p>
<p>$$M ^\mathcal{T} = S ^\mathcal{T} V ^\mathcal{T}$$</p>
<p>$$U ^\mathcal{T} = ReLu(ReLu(\hat{M} ^{'\mathcal{T}}W _0 ^\mathcal{T})W _1 ^\mathcal{T})W _2 ^\mathcal{T}$$</p>
<p>where $M ^{'\mathcal{T}} = \hat{X} ^{\mathcal{T}} + M ^{\mathcal{T}}$ is the residual connections.</p>
<p>For each node, its output is $\hat{Y} ^\mathcal{T} = U  ^\mathcal{T} + M ^\mathcal{'T}$</p>
<h2 id="Experiments">Experiments</h2>
<p><img src="exp1.png" alt="exp1"></p>
<p><img src="exp2.png" alt="exp2"></p>
<p><img src="exp3.png" alt="exp3"></p>
<h2 id="The-paper">The paper</h2>


	<div class="row">
    <embed src="STTN.pdf" width="100%" height="550" type="application/pdf">
	</div>





        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/Informer/" data-toggle="tooltip" data-placement="top" title="Informer:Beyond Efficient Transformer for Long Sequence Time-Series Forecasting">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/en/ST-GRAT/" data-toggle="tooltip" data-placement="top" title="ST-GRAT:A Novel Spatio-temporal Graph Attention Network for Accurately Forecasting Dynamically Changing Road Speed">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=STTN:Spatial-Temporal Transformer Networks for Traffic Flow Forecasting&body=Hi,I found this website and thought you might like it http://yoursite-url/en/STTN/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '04b857744df6aca41a4b',
      clientSecret: '46345ef524913d79f188d03d10e82693a1b90cbe',
      repo: 'blogcomment',
      owner: 'ccloud0525',
      admin: 'ccloud0525',
      id: 'Sun Feb 05 2023 19:51:00 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'zh-CN',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Introduction"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Introduction</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Proposed-Model"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Proposed Model</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Problem-Formulation"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">Problem Formulation</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Overall-Architecture"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">Overall Architecture</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Spatial-temporal-Blocks"><span class="toc-nav-number">2.2.1.</span> <span class="toc-nav-text">Spatial-temporal Blocks</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Prediction-Layer"><span class="toc-nav-number">2.2.2.</span> <span class="toc-nav-text">Prediction Layer</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Spatial-Transformer"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">Spatial Transformer</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Spatial-Temporal-Positional-Embedding"><span class="toc-nav-number">2.3.1.</span> <span class="toc-nav-text">Spatial-Temporal Positional Embedding</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Fixed-Graph-Convolutional-Layer"><span class="toc-nav-number">2.3.2.</span> <span class="toc-nav-text">Fixed Graph Convolutional Layer</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Dynamical-Graph-Convolutional-Layer"><span class="toc-nav-number">2.3.3.</span> <span class="toc-nav-text">Dynamical Graph Convolutional Layer</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Gate-Mechanism-for-Feature-Fusion"><span class="toc-nav-number">2.3.4.</span> <span class="toc-nav-text">Gate Mechanism for Feature Fusion</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#General-Dynamical-Graph-Neural-Networks"><span class="toc-nav-number">2.3.5.</span> <span class="toc-nav-text">General Dynamical Graph Neural Networks</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Temporal-Transformers"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">Temporal Transformers</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Experiments"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">Experiments</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#The-paper"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">The paper</span></a></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#注意力机制" title="注意力机制">注意力机制</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://github.com/Cyria7" target="_blank">Cyria7</a>
          </li>
          
          <li>
            <a href="https://github.com/ameki77" target="_blank">ameki77</a>
          </li>
          
          <li>
            <a href="https://picasun.github.io/" target="_blank">Picasun</a>
          </li>
          
          <li>
            <a href="https://hexo.io/" target="_blank">Hexo</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/ccloud0525">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          
            <li>
              <a target="_blank" href="https://www.zhihu.com/people/tian-xing-jian-82-19">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse">知</i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="http://weibo.com/6386058030">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Cloud
          2023
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://yoursite-url/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_CHTML"></script>


</body>
</html>
